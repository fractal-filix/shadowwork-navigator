# 2026.03.04 Runbook（AWS KMS 非対称鍵 / CloudTrail / IAM）

このドキュメントは [docs/sprints/sprint1/task.md](task.md) の **2026.03.04** に対応する「設定」手順書です。

対象タスク:
- 1.2.2 KMSの非対称鍵ペアを作成（用途: ENCRYPT_DECRYPT）
- 1.2.3 公開鍵取得（GetPublicKey）と kid（鍵識別子）運用を確定
- 1.2.4 CloudTrailを有効化（KMS操作の監査ログ）
- 1.2.5 IAMポリシーを作成
- 1.2.5.1 公開鍵取得（GetPublicKey）の許可主体を確定

---

## 前提

- AWS CLI が利用できること（または Console 手順でも可）
- 作業リージョンを決めていること（例: `ap-northeast-1`）
- KMS キーは「封筒暗号の KEK 相当（RSA 公開鍵で DEK をラップ / 私鍵でアンラップ）」として使う想定

以降で使うプレースホルダ:
- `<AWS_REGION>`: 例 `ap-northeast-1`
- `<KMS_KEY_ID>`: 例 `1234abcd-...`（KeyId）
- `<KMS_KEY_ARN>`: 例 `arn:aws:kms:...:key/1234...`
- `<KMS_ALIAS>`: 例 `alias/shadownav/kek-rsa-oaep`

---

## 1.2.2 KMS 非対称鍵ペアを作成（ENCRYPT_DECRYPT）

### 推奨パラメータ（まずはこれで固定）
- KeySpec: `RSA_2048`（Web側での RSA-OAEP ラップ用途を想定）
- KeyUsage: `ENCRYPT_DECRYPT`
- Tags:
  - `Project=shadowwork-navigator`
  - `Env=production`（または `staging`）
  - `Purpose=kek`

> 注: 署名用途（SIGN_VERIFY）ではなく暗号用途（ENCRYPT_DECRYPT）を選びます。

### Console（GUI）手順
1) AWS Console → KMS → Customer managed keys → Create key
2) Key type: Asymmetric
3) Key usage: Encrypt and decrypt
4) Key spec: RSA_2048
5) Alias を設定（例: `<KMS_ALIAS>`）
6) Key administrators / Key users を設定（後述の IAM 設計に従う）
7) 作成後、KeyId / KeyArn を控える

### AWS CLI 手順（例）

```bash
aws kms create-key --region <AWS_REGION> --key-usage ENCRYPT_DECRYPT --key-spec RSA_2048 --description "shadowwork-navigator KEK (RSA-OAEP)" --tags TagKey=Project,TagValue=shadowwork-navigator TagKey=Purpose,TagValue=kek
```

Alias 作成（`<KMS_KEY_ID>` を create-key の結果から取得）:

```bash
aws kms create-alias --region <AWS_REGION> --alias-name <KMS_ALIAS> --target-key-id <KMS_KEY_ID>
```

確認:

```bash
aws kms describe-key --region <AWS_REGION> --key-id <KMS_KEY_ID>
aws kms list-aliases --region <AWS_REGION> | findstr shadownav
```

---

## 1.2.3 GetPublicKey と kid 運用

### 公開鍵の取得（GetPublicKey）

```bash
aws kms get-public-key --region <AWS_REGION> --key-id <KMS_KEY_ID> --output json > kms-public-key.json
```

- `PublicKey` は base64 で返ります。
- 将来の API（例: `GET /api/crypto/kms_public_key`）で配布する形式は、後続タスク 4.3.* で最終決定します。

### kid（鍵識別子）をどうするか

このプロジェクトでは、まず以下のどちらかで運用を確定させるのが安全です。

#### 案A（推奨）: `kid = KMS KeyId`
- 例: `1234abcd-...`（UUID）
- 長所: 追加の計算が不要、確実に一意、運用が簡単
- 短所: キーローテーション時に kid が変わる（ただしそれで良い設計にする）

#### 案B: `kid = 公開鍵のサムプリント（JWK thumbprint等）`
- 長所: 公開鍵の内容に基づくため、配布キーの同一性が明確
- 短所: 変換・計算実装が必要（Web/Workers 両側の整合も必要）

まずは案Aで前に進め、必要になった時点（複数鍵併用・ローテーション設計の精緻化）で案Bへ移行可能です。

### kid の保存場所
- 運用メモとして `task.md`（完了欄）または別紙に `<KMS_KEY_ID>` と `<KMS_ALIAS>` を控える
- 実装では `KMS_KEY_ID` を Workers Vars/Secrets で参照する（後続タスク 1.5.1.7.4）

---

## 1.2.4 CloudTrail を有効化（KMS操作の監査ログ）

目的:
- `kms:Decrypt`（将来のアンラップ）など重要操作の監査証跡を残す

### 最小構成（推奨）
- 管理イベント（Management events）を記録（デフォルトで KMS を含む）
- S3 バケットへ保存
- 可能なら CloudWatch Logs にも転送（アラート/検索のため）

### Console 手順（概要）
1) CloudTrail → Trails → Create trail
2) Trail name: `shadowwork-navigator-trail`
3) Storage location（S3）を作成/選択
4) Log file SSE（暗号化）を有効化（SSE-S3 か SSE-KMS）
5) Management events: Read/Write を両方有効化
6) 作成後、Trail を有効化

### 監査できること（例）
- 誰が（どの IAM principal が）いつ `kms:Decrypt` / `kms:GetPublicKey` を呼んだか

---

## 1.2.5 IAM ポリシー作成 / 1.2.5.1 GetPublicKey の許可主体

### 設計方針
- 公開鍵の配布 API は「外部へ公開」されうるが、AWS 側の `kms:GetPublicKey` を叩けるのは **API実行主体のみ** に限定する
- `kms:Decrypt` はさらに強い制限（後続タスク 1.2.5.2 / 4.4.* で確定）

### GetPublicKey の許可主体（まずの結論）
- 許可主体: Cloudflare Workers が利用する AWS 資格情報（IAM User もしくは Role）
- それ以外（開発者個人・一般ユーザー・CIなど）は原則不可

### ポリシー雛形
- GetPublicKey のみ許可する最小ポリシー: [docs/sprints/sprint1/aws/iam/kms_get_public_key_policy.json](aws/iam/kms_get_public_key_policy.json)
- Decrypt を含むポリシーは後続タスクで追加（今は分離推奨）

### 次（03/06 の 1.5.1.7 へ繋ぐ）
- Workers 側に `AWS_REGION`, `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `KMS_KEY_ID` を登録する
- キーIDは alias ではなく KeyId/KeyArn を推奨（alias 変更による意図せぬ切替を防ぐ）
