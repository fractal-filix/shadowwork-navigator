# 2026.03.02 Runbook（Stripe Webhook / Supabase 初期セットアップ）

このドキュメントは [docs/sprints/sprint1/task.md](task.md) の **2026.03.02** に対応する「確認・設定」手順書です。

## 1.7 Stripe Webhook（確認）

### 1.7.2 Webhook URL の向き先確認

目的: Stripe 側の Webhook エンドポイントが `https://api.shadowwork-navigator.com/api/stripe/webhook` を指していることを確認する。

- Stripe Dashboard（本番 / Live）
  - Developers → Webhooks
  - 対象 endpoint の URL が `https://api.shadowwork-navigator.com/api/stripe/webhook` であること
  - Listen しているイベントに `checkout.session.completed` が含まれていること（本実装が処理するイベント）

参考: URL 到達性のローカル確認（署名ヘッダ無しなので 400 が期待値）

```bash
curl -i -X POST https://api.shadowwork-navigator.com/api/stripe/webhook
```

Windows で証明書失効チェックが失敗する場合:

```bash
curl --ssl-no-revoke -i -X POST https://api.shadowwork-navigator.com/api/stripe/webhook
```

実装側の根拠:
- API ルーティングは `apps/api/src/worker.ts` で `POST /api/stripe/webhook` を登録済み
- 署名検証ロジックは `apps/api/src/handlers/stripe_webhook.ts` に実装済み

### 1.7.3 STRIPE_WEBHOOK_SECRET の登録確認（Workers Secrets）

目的: Cloudflare Workers（staging / production）に `STRIPE_WEBHOOK_SECRET` が登録されていることを確認する。

1) Secrets の一覧表示（staging / production）

```bash
cd apps/api
pnpm exec wrangler secret list --env staging
pnpm exec wrangler secret list --env production
```

2) 未登録の場合の登録（Stripe Dashboard で endpoint の Signing secret を取得して投入）

```bash
cd apps/api
pnpm exec wrangler secret put STRIPE_WEBHOOK_SECRET --env staging
pnpm exec wrangler secret put STRIPE_WEBHOOK_SECRET --env production
```

注意:
- `STRIPE_WEBHOOK_SECRET` は endpoint ごとに発行されます（例: `whsec_...`）。staging と production で endpoint を分けている場合、secret も分けて登録してください。

## 1.1 Supabase（初期セットアップ）

### 1.1.1 Supabase アカウント作成
- Supabase にログインできる状態にする。

### 1.1.2 Project 作成（リージョン/プラン決定）
- Project を作成し、Project 名とリージョンを決定する。

### 1.1.3 Auth 有効化（Email + Password）
- Authentication の Provider で Email を有効にする。

### 1.1.4 Site URL / Redirect URLs の追加
- `https://shadowwork-navigator.com` を Site URL / Redirect URLs に追加する。

### 1.1.5 テストユーザ作成（β検証用）
- Email + Password でテストユーザを作成して、ログイン動作を確認する。

### 1.1.6 API 側でトークン検証に必要な情報を取得・保管
このスプリントでは最終的に `/api/auth/exchange` の検証方式を Supabase JWT へ移行します（後続タスク 2.1）。
その前提として、以下の値を Supabase 側で確認して控えます。

### 1.1.6.1 SUPABASE_URL を取得
- Supabase Dashboard → Project Settings → API
- Project URL（例: `https://xxxx.supabase.co`）を控える

次のステップ（03.03 想定）:
- `SUPABASE_ANON_KEY` 等の取得と Workers への登録（task.md の 03.03 を参照）

## 2026.03.03 追記

### 1.1.6.4 JWKS URL / issuer / audience の確定

このリポジトリでは Supabase JWT 検証パラメータを以下で固定します。

- `SUPABASE_JWKS_URL`: `https://bekltsvemtvbjxwrqvxg.supabase.co/auth/v1/.well-known/jwks.json`
- `SUPABASE_ISSUER`: `https://bekltsvemtvbjxwrqvxg.supabase.co/auth/v1`
- `SUPABASE_AUDIENCE`: `authenticated`

反映箇所:
- `apps/api/wrangler.toml`（staging / production vars）
- `apps/api/src/types/env.ts`（Env型）
- `apps/api/scripts/verify-jwt.mjs`（検証サンプル）

### 1.5.2 / 1.5.2.1 / 1.5.2.2 Web（Pages）設定反映

Web 側で次の設定キーを利用可能にしています（`apps/web/pages/lib/client.js`）。

- `SHADOWNAV_API_BASE`（既定: `https://api.shadowwork-navigator.com`）
- `SHADOWNAV_SUPABASE_URL`
- `SHADOWNAV_SUPABASE_ANON_KEY`

一時反映（ブラウザ Console）:

```js
localStorage.setItem("SHADOWNAV_API_BASE", "https://api.shadowwork-navigator.com");
localStorage.setItem("SHADOWNAV_SUPABASE_URL", "https://bekltsvemtvbjxwrqvxg.supabase.co");
localStorage.setItem("SHADOWNAV_SUPABASE_ANON_KEY", "<SUPABASE_ANON_KEY>");
location.reload();
```

### 1.6.1 Workers（staging/production）のVars/Secrets反映確認

1) Secrets の登録有無を確認

```bash
cd apps/api
pnpm exec wrangler secret list --env staging
pnpm exec wrangler secret list --env production
```

2) Vars は `apps/api/wrangler.toml` の `env.staging.vars` / `env.production.vars` を確認

03.03時点で確認対象に含める値:
- `ALLOWED_ORIGINS`
- `JWT_ISSUER`, `JWT_AUDIENCE`, `ACCESS_TOKEN_TTL_SECONDS`
- `SUPABASE_URL`, `SUPABASE_JWKS_URL`, `SUPABASE_ISSUER`, `SUPABASE_AUDIENCE`
