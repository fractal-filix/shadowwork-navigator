# Copilot 指示 (TDD 前提 — レビューしやすい実装)

目的
- TDD（テスト先行）を標準ワークフローとし、小さなコミットで確実に動作を追加・保守する。

言語
- 必ず日本語で出力すること。

基本ワークフロー（必須）
1. 仕様を一文で定義（What/Why）。  
2. 失敗するテストを書く（単体テストを優先）。  
3. 最小限の実装でテストを通す（1コミット＝1責務）。  
4. リファクタ（テストが通ることを前提に安全に行う）。  
5. 必要なら統合テストを追加し、エンドツーエンドの振る舞いを検証。  
6. ドキュメント/CHANGELOG を更新。

出力の粒度
- 1 PR = 1 機能または修正（複数ファイル可だが「単一の論理的変更」に限定）。  
- まず「テストのスタブ（失敗するテスト）」→ 次に「最小実装」→ 次に「統合テスト／ドキュメント」の順で分割すること。

テスト方針
- 単体テストは依存をモック／スタブ化する（Stripe, DB, 外部API等）。  
- 成功ケースと失敗ケースを両方必ず含める。  
- DB はトランザクションで巻き戻すか、テスト専用インスタンスを使用する。  
- 時刻・乱数は固定化／モックする（再現性のため）。  
- テスト実行コマンドは package.json の `test` を使う（例: npm test / pnpm test）。PR に実行手順を明記すること。

CI と品質
- CI はすべてのテストを必須にする。  
- Lint/フォーマットは PR 前に自動で適用する。  
- セキュリティ/秘密は環境変数のみ使用。テスト用シークレットは fixtures に置く（本物は不可）。

コミット / PR ルール
- ブランチ名: feature/<短説明>、fix/<issue#>-<短説明>。  
- コミット: `type(scope): short description` — コミットメッセージは必ず日本語で記述してください（例: `feat(api): Stripe webhook テストスタブ追加`）。  
- PR テンプレ必須: 概要 / なぜ / 変更点（ファイル一覧） / テスト手順 / 影響範囲 / チェックリスト。

レビュー向け差分要約（自動付与推奨）
- 変更ファイル一覧（added/modified/removed）。  
- 各ファイル1-2行の要約（何を・なぜ変更したか）。  
- 主要なテストケース一覧と期待結果。  
- コマンド（npm test 等）と CI 結果のリンク。

小さな実装例フロー（テンプレ）
- 1) `tests/unit/<feature>.test.js` の失敗するテストを追加（期待値を明記）→ commit `test(<feature>): 失敗するテストを追加`  
- 2) 実装（最小）を追加してテスト通過 → commit `feat(<feature>): テストを通す最小実装を追加`  
- 3) 統合テストを追加／ドキュメント更新 → commit `test/integr: <feature> の統合テストを追加` / `docs: <feature> 使用法を更新`  
- 4) リファクタ／最適化 → commit `refactor(<area>): 可読性を改善`  

補足
- 大規模変更はまず設計 PR（非破壊）を作成して合意を得る。  
- 自動生成コードは必ずレビューしやすい小単位で出力させる（テストスタブ→実装 の順を厳守）。
